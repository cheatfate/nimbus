version: '{build}'

cache:
- x86_64-4.9.2-release-win32-seh-rt_v4-rev4.7z
- i686-4.9.2-release-win32-dwarf-rt_v4-rev4.7z
- sqlite-dll-win32-x86-3240000.zip
- sqlite-dll-win64-x64-3240000.zip
- c:\tools\vcpkg\installed\

# We always want 32 and 64-bit compilation
matrix:
  fast_finish: false     # set this flag to immediately finish build once one of the jobs fails.

environment:

  matrix:
    - MINGW_DIR: mingw32
      MINGW_URL: https://sourceforge.net/projects/mingw-w64/files/Toolchains%20targetting%20Win32/Personal%20Builds/mingw-builds/4.9.2/threads-win32/dwarf/i686-4.9.2-release-win32-dwarf-rt_v4-rev4.7z/download
      MINGW_ARCHIVE: i686-4.9.2-release-win32-dwarf-rt_v4-rev4.7z
      SQLITE_URL: https://www.sqlite.org/2018/sqlite-dll-win32-x86-3240000.zip
      SQLITE_ARCHIVE: sqlite-dll-win32-x86-3240000.zip
      ROCKSDB_PACKAGE: rocksdb:x86-windows
      VCPKG_DIR: C:\TOOLS\VCPKG\INSTALLED\x86-windows
      platform: x86
    - MINGW_DIR: mingw64
      MINGW_URL: https://sourceforge.net/projects/mingw-w64/files/Toolchains%20targetting%20Win64/Personal%20Builds/mingw-builds/4.9.2/threads-win32/seh/x86_64-4.9.2-release-win32-seh-rt_v4-rev4.7z/download
      MINGW_ARCHIVE: x86_64-4.9.2-release-win32-seh-rt_v4-rev4.7z
      SQLITE_URL: https://www.sqlite.org/2018/sqlite-dll-win64-x64-3240000.zip
      SQLITE_ARCHIVE: sqlite-dll-win64-x64-3240000.zip
      ROCKSDB_PACKAGE: rocksdb:x64-windows
      VCPKG_DIR: C:\TOOLS\VCPKG\INSTALLED\x64-windows
      platform: x64

install:
  - setlocal EnableExtensions EnableDelayedExpansion
  - MKDIR %CD%\bin
  - IF not exist "%MINGW_ARCHIVE%" appveyor DownloadFile "%MINGW_URL%" -FileName "%MINGW_ARCHIVE%"
  - 7z x -y "%MINGW_ARCHIVE%" > nul
  - IF not exist "%SQLITE_ARCHIVE%" appveyor DownloadFile "%SQLITE_URL%" -FileName "%SQLITE_ARCHIVE%"
  - 7z x -y "%SQLITE_ARCHIVE%" > nul
  - IF "%PLATFORM%" == "x64" ( copy %CD%\sqlite3.dll %CD%\bin\sqlite3_64.dll ) ELSE ( copy %CD%\sqlite3.dll %CD%\bin\sqlite3_32.dll )
  - vcpkg install "%ROCKSDB_PACKAGE%"
  - copy %VCPKG_DIR%\bin\rocksdb_shared.dll %CD%\bin\librocksdb.dll && copy %VCPKG_DIR%\bin\zlib1.dll %CD%\bin\zlib1.dll
  - SET PATH=%CD%\%MINGW_DIR%\bin;%CD%\bin;%CD%\Nim\bin;%PATH%
  - git clone https://github.com/nim-lang/Nim.git
  - cd %CD%\Nim
  - git remote add statusim https://github.com/status-im/Nim.git
  - git fetch statusim
  - git config --global user.email "you@example.com"
  - git config --global user.name "Your Name"
  - for /f "tokens=*" %%G IN ('git branch -a --list ^"statusim/status-autopatch-*^"') DO (git merge %%G)
  - git clone --depth 1 https://github.com/nim-lang/csources
  - cd csources
  - IF "%PLATFORM%" == "x64" ( build64.bat ) else ( build.bat )
  - cd ..
  - bin\nim c koch
  - koch boot -d:release
  - koch nimble
build_script:
  - cd C:\projects\%APPVEYOR_PROJECT_SLUG%
  - nimble install -y
test_script:
  - nimble test

deploy: off
